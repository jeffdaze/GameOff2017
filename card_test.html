<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Card system test</title>
    <style>
        .card{
            margin:5px;
            padding:10px;
            width:150px;
            height:200px;
            border:3px solid #000;
            border-radius: 20px;
            float:left;
            cursor: pointer;
        }
        .text{
            margin-top: 20px;
        }

        #playerDeckCount{
            float:none;
        }
    </style>
</head>
<body>
<button id="start">Start</button>
<div id="enemyLife"></div>
<div id="enemyDeckCount"></div>
<div id="enemyHand"></div>
<br />
<br />
<br />
<br />
<div id="playerLife"></div>
<div id="playerDeckCount" class="card"></div>
<div id="playerHand"></div>


<script>
//Card definitions..

//id: Used to index cards when making a deck
//name: name that appears in the card listing
//function: category of card and what it's used for
//text: descriptive text that appears when viewing the card
//duration: how many rounds the effect is active; -1 means infinite or until it's removed / destroyed
//icon: image name to use for the card
//value: the numeric amount that is used when applying the effect

const cards = {

    "a1": {
        name: "attack1",
        type: "offence",
        text: "Does 1 point of damage to the target opponent",
        duration:"1",
        icon: "",
        value: 1,
        action: function()
        {
            enemy.currentLife -= this.value;
            updateEnemyLife();
        }
    },

    "a2": {
        name: "attack2",
        type: "offence",
        text: "Does 2 points of damage to the target opponent",
        duration:"1",
        icon: "",
        value: 2,
        action: function()
        {
            enemy.currentLife -= this.value;
            updateEnemyLife();
        }
    },
    "b1": {
        name: "block1",
        type: "defence",
        text: "Absorbs up to 2 points of damage from the next attack ",
        duration:"-1",
        icon: "",
        value: 2,
        action: function()
        {
            console.log(this);
        }
    },
    "b2": {
        name: "block2",
        type: "defence",
        text: "Absorbs up to 3 points of damage from the next attack ",
        duration:"-1",
        icon: "",
        value: 3,
        action: function()
        {
            console.log(this);
        }
    },
    "s1": {
        name: "shield1",
        type: "defence",
        text: "Improved defence. Absorbs 1 point of damage",
        duration: "-1",
        icon: "",
        value: 1,
        action: function()
        {
            console.log(this);
        }
    },
    "s2": {
        name: "shield2",
        type: "defence",
        text: "Improved defence. Absorbs 2 points of damage",
        duration: "-1",
        icon: "",
        value: 2,
        action: function()
        {
            console.log(this);
        }
    },
    "w1": {
        name: "sword1",
        type: "offence",
        text: "Improved offence. Inflicts 1 additional point of damage",
        duration: "-1",
        icon: "",
        value: 1,
        action: function()
        {
            console.log(this);
        }
    },
    "w2": {
        name: "sword2",
        type: "offence",
        text: "Improved offence. Inflicts 2 additional points of damage",
        duration: "-1",
        icon: "",
        value: 2,
        action: function()
        {
            console.log(this);
        }
    },
    "h1": {
        name: "heal1",
        type: "heal",
        text: "Heals 1 point",
        duration: "0",
        icon: "",
        value: 1,
        action: function()
        {
            player.currentLife += this.value;
            updatePlayerLife();
        }
    },
    "h2": {
        name: "heal2",
        type: "heal",
        text: "Heals 2 points",
        duration: "0",
        icon: "",
        value: 2,
        action: function()
        {
            player.currentLife += this.value;
            updatePlayerLife();
        }
    },
    "d1": {
        name: "discard1",
        type: "deckmanipulation",
        text: "Target opponent discards 1 card",
        duration: "1",
        icon: "",
        value: 1,
        action: function()
        {
            enemy.currentHand.pop();
            updateEnemyHand();
        }
    },
    "d2": {
        name: "draw1",
        type: "deckmanipulation",
        text: "Draw 1 card",
        duration: "1",
        icon: "",
        value: 1,
        action: function()
        {
            drawCard();
        }
    },
    "d3": {
        name: "redraw1",
        type: "deckmanipulation",
        text: "Shuffle discarded cards back into your deck",
        duration: "1",
        icon: "",
        value: 1,
        action: function()
        {
            console.log(this);
        }
    },
    "p1": {
        name: "play1",
        type: "play",
        text: "Play 2 more cards this round",
        duration: "1",
        icon: "",
        value: 2,
        action: function()
        {
            console.log(this);
        }
    }
};

let allCardIds = [
    "a1",
    "a2",
    "b1",
    "b2",
    "s1",
    "s2",
    "w1",
    "w2",
    "h1",
    "h2",
    "d1",
    "d2",
    "d3",
    "p1"
];

//some starting vars...
const baseDeckLimit = 20;
const baseLifeLimit = 10;
const baseHandLimit = 5;

//player object...
let player = {
    currentLife: baseLifeLimit,
    currentHandLimit: baseHandLimit,
    currentDeckLimit: baseDeckLimit,
    currentHand: [],
    currentCardsInPlay: [],
    currentCards: [
        "a1",
        "a1",
        "a1",
        "a1",
        "a2",
        "a2",
        "h1",
        "h1",
        "h1",
        "b1",
        "b2",
        "s1",
        "s1",
        "s2",
        "w1",
        "w2",
        "d1",
        "d2",
        "d3",
        "p1"
    ],
    currentDeck: [
            "a1",
            "a1",
            "a1",
            "a1",
            "a2",
            "a2",
            "b1",
            "b2",
            "h1",
            "h1",
            "h1",
            "s1",
            "s1",
            "s2",
            "w1",
            "w2",
            "d1",
            "d2",
            "d3",
            "p1"
    ],
    currentDiscard: []
};

//enemy object...
let enemy = {
    currentLife: baseLifeLimit,
    currentHandLimit: baseHandLimit,
    currentDeckLimit: baseDeckLimit,
    currentDeck: [],
    currentHand: [],
    currentCardsInPlay: [],
    currentDiscard: []
};


//bind clicks to buttons...
document.getElementById("start").addEventListener('click', function() {
    runGame();
}, false);

document.getElementById("playerDeckCount").addEventListener('click', function() {
    //check if there are any more cards that can be drawn...
    if(checkDeck())
    {
        //draw another card...
        drawCard();

        //update the display...
        updateDeckCount();

        //show the user hand...
        renderHand();
    }

}, false);

function runGame()
{
    //build a deck for the enemy...
    for(var x =0; x<enemy.currentDeckLimit; x++)
    {
        enemy.currentDeck.push(getArrItem(allCardIds));
    }

    //shuffle the player deck...
    player.currentDeck = shuffle(player.currentDeck);

    //set life values...
    updateEnemyLife();
    updatePlayerLife();

    //draw cards...
    for(var y = 0; y<enemy.currentHandLimit; y++)
    {
        enemy.currentHand.push(enemy.currentDeck.pop());
    }

    for(var z = 0; z<player.currentHandLimit; z++)
    {
        drawCard();
    }

    //list remaining cards...
    document.getElementById("enemyDeckCount").innerHTML = enemy.currentDeck.length;
    updateDeckCount();

    //list cards in hand...
    updateEnemyHand();

    renderHand();


}



//get a card definition...
let cardValue = (cardId) => cards[cardId];

//player uses a card from their hand...
let playCard = (cardIndex) => {
    console.log(cardIndex);

    //get the card
    let activeCard = player.currentHand[cardIndex];

    //console.log(activeCard);

    //run the card function...
    cards[activeCard].action();

    //discard the card if necessary...
    handleDiscard(cardIndex);

};

let renderHand = () => {

    //clear the hand for re-rendering...
    document.getElementById("playerHand").innerHTML = "";

    //use let here instead of var for locally scoped var and no need of a closure
    //to use i inside the event listener...
    for(let i=0; i<player.currentHand.length; i++)
    {

        let cardTitle = document.createElement("div");
        cardTitle.innerText = `${cardValue(player.currentHand[i]).name}`;

        let cardText = document.createElement("div");
        cardText.className = "text";
        cardText.innerText = `${cardValue(player.currentHand[i]).text}`;

        //create a card div...
        let div = document.createElement("div");
        div.className = "card";
        div.appendChild(cardTitle);
        div.appendChild(cardText);

        //pass in the index of the current card...
        div.addEventListener('click', function () {
            playCard(i);
        }, false);

        document.getElementById("playerHand").appendChild(div);

    }
};


let handleDeck = () => {
    //check if there are any more cards that can be drawn...
    checkDeck();

    //draw another card...
    drawCard();

    //update the display...
    updateDeckCount();

    //show the user hand...
    renderHand();
};


let checkDeck = () => {
    if(player.currentDeck.length === 0)
    {
        console.log("You lose...");
        return false;
    }
    return true;
};

let handleDiscard = (cardIndex) => {
    //copy the current card to the discard pile...
    player.currentDiscard.push(player.currentHand[cardIndex]);

    //now remove the card from the player hand...
    player.currentHand.splice(cardIndex, 1);

    //show the user hand...
    renderHand();
};

let drawCard = () => player.currentHand.push(player.currentDeck.pop());

let updateDeckCount = () => document.getElementById("playerDeckCount").innerHTML = player.currentDeck.length;

let updatePlayerLife = () => document.getElementById("playerLife").innerHTML = player.currentLife;

let updateEnemyLife = () => document.getElementById("enemyLife").innerHTML = enemy.currentLife;

let updateEnemyHand = () => document.getElementById("enemyHand").innerHTML = `${enemy.currentHand}`;

//utility functions...
//return a random array value...
let getArrItem = (arr) => arr[Math.floor(Math.random() * arr.length)];

//shuffles an array...
function shuffle(array) {
    let counter = array.length;

    // While there are elements in the array
    while (counter > 0) {
        // Pick a random index
        let index = Math.floor(Math.random() * counter);

        // Decrease counter by 1
        counter--;

        // And swap the last element with it
        let temp = array[counter];
        array[counter] = array[index];
        array[index] = temp;
    }

    return array;
}

</script>
</body>
</html>